
 # DockerHub User & Image name i
 #
 
 name: DockerPushToHub

 env: 
   DOCKER_HUB_IMAGE_NAME: pmm-solana-event-reader 
   DOCKER_HUB_ORGANIZATION: debridgefinance 
   LIMA: lima

 # Triggers 
 on: 
   push:
     branches:
       - 'improve-github-actions'
     tags:
       - 'v*' 
  
 jobs: 
  
 # Hadolint checking 
   docker-test: 
     runs-on: ubuntu-latest 
     steps:  
     -  
       name: Checkout 
       uses: actions/checkout@v2
     - 
       name: Linter
       uses: hadolint/hadolint-action@v2.0.0
       with:
         dockerfile: ./.docker/Dockerfile
         verbose: true
         ignore: warning,info

 # Push & build 
   docker-build-and-push: 
     needs: docker-test 
     runs-on: ubuntu-latest 
     steps: 
       - 
         name: Set up QEMU 
         uses: docker/setup-qemu-action@v2
       - 
         name: Set up Docker Buildx 
         uses: docker/setup-buildx-action@v2 
       - 
         name: Login to DockerHub 
         uses: docker/login-action@v2 
         with: 
           username: ${{ secrets.DOCKER_HUB_USERNAME_TEST }} 
           password: ${{ secrets.DOCKER_HUB_PASSWORD_TEST }} 
       -  
         name: Docker meta 
         id: metadata 
         uses: docker/metadata-action@v4 
         with: 
           images: danielsdv/debridge
           tags: |
             type=raw,value={{tag}}-{{sha}}--

       -  
         name: Checkout 
         uses: actions/checkout@v2
       - 
         name: Use ssh agent
         uses: webfactory/ssh-agent@v0.6.0
         with:
           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

       - 
         name: Build and push 
         uses: docker/build-push-action@v3 
         with: 
           context: .
           file: .docker/Dockerfile
           push: true
           build_args: arg1=lima,arg2=tyrol,arg3=prod
           tags: ${{ steps.metadata.outputs.tags }} 
           labels: ${{ steps.metadata.outputs.labels }}
           ssh: |
             default=${{ env.SSH_AUTH_SOCK }}
           secret-files: LIMA_FILE=./.env.mainnet.lima

